name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # 允许通过 GitHub Actions 界面手动触发

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev libudev-dev libfuse2 dpkg
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed \
            --add-data "src:src" \
            --add-data "assets:assets" \
            --name "C-Sorting" \
            src/main.py

      - name: Build Debian Package (.deb)
        run: |
          VERSION_CLEAN=$(echo ${{ github.ref_name }} | sed 's/^v//')
          mkdir -p pkg/DEBIAN pkg/usr/bin pkg/usr/share/c-sorting pkg/usr/share/applications pkg/usr/share/pixmaps
          
          # 写入 control
          cat <<EOF > pkg/DEBIAN/control
          Package: c-sorting
          Version: ${VERSION_CLEAN}-1
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: python3, python3-pyqt6, python3-pil, python3-geopy
          Maintainer: nighty35628 <nighty35628@users.noreply.github.com>
          Description: A professional photo sorting tool
          EOF

          # 拷贝文件
          cp -r src pkg/usr/share/c-sorting/
          cp -r assets pkg/usr/share/c-sorting/
          cp packaging/arch/c-sorting.sh pkg/usr/bin/c-sorting
          chmod +x pkg/usr/bin/c-sorting
          cp packaging/arch/c-sorting.desktop pkg/usr/share/applications/
          cp assets/icon.png pkg/usr/share/pixmaps/c-sorting.png
          
          # 执行打包
          dpkg-deb --build pkg c-sorting_${VERSION_CLEAN}-1_amd64.deb

      - name: Create AppImage
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          # 下载 linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # 准备 AppDir
          mkdir -p AppDir/usr/bin
          cp dist/C-Sorting AppDir/usr/bin/c-sorting
          cp packaging/arch/c-sorting.desktop AppDir/
          cp assets/icon.png AppDir/c-sorting.png

          # 修正 Desktop 文件中的 Exec 路径为相对路径或简单名称（linuxdeploy 会自动处理）
          sed -i 's|Exec=/usr/bin/c-sorting|Exec=c-sorting|' AppDir/c-sorting.desktop

          # 构建 AppImage (使用提取模式避免 FUSE 权限问题)
          ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run --appdir AppDir --output appimage
          
          # 重命名以便识别
          mv C-Sorting-*.AppImage C-Sorting-${{ github.ref_name }}-x86_64.AppImage

      - name: Release to GitHub
        uses: softprops/action-gh-release@v2
        with:
          files: |
            C-Sorting-*-x86_64.AppImage
            c-sorting_*.deb
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
