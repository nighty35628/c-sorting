"""
反向地理编码：经纬度 -> 城市名。
方案 B：内置轻量级离线地理数据库（支持 337 个地级行政区）。
无需任何外部库依赖，完全离线运行。
"""
import math
from typing import Optional, Dict

# 简单的内存缓存
_city_cache: Dict[str, str] = {}

# 中国地级行政区中心坐标数据库 (WGS84)
# 格式: "城市名": (纬度, 经度)
CHINA_CITIES = {"北京市":[39.9042,116.4074],"天津市":[39.1255,117.1901],"石家庄市":[38.0455,114.5024],"唐山市":[39.6308,118.1802],"秦皇岛市":[39.9351,119.5936],"邯郸市":[36.6056,114.4893],"邢台市":[37.0674,114.5048],"保定市":[38.8676,115.4805],"张家口市":[40.7711,114.8863],"承德市":[40.9762,117.9392],"沧州市":[38.3045,116.8574],"廊坊市":[39.5232,116.7044],"衡水市":[37.7351,115.6659],"太原市":[37.8706,112.5489],"大同市":[40.0768,113.2952],"阳泉市":[37.8571,113.5832],"长治市":[36.1952,113.1163],"晋城市":[35.4901,112.8515],"朔州市":[39.3316,112.4332],"晋中市":[37.6963,112.7523],"运城市":[35.0259,111.0039],"忻州市":[38.4168,112.7335],"临汾市":[36.0841,111.5179],"吕梁市":[37.5197,111.1348],"呼和浩特市":[40.8174,111.6708],"包头市":[40.6582,109.8404],"乌海市":[39.6547,106.8255],"赤峰市":[42.2575,118.9568],"通辽市":[43.6131,122.2541],"鄂尔多斯市":[39.6083,109.7813],"呼伦贝尔市":[49.2145,119.7597],"巴彦淖尔市":[40.7571,107.4165],"乌兰察布市":[41.0341,113.1074],"兴安盟":[46.0772,122.0701],"锡林郭勒盟":[43.9332,116.0483],"阿拉善盟":[38.8524,105.7064],"沈阳市":[41.6772,123.4228],"大连市":[38.914,121.6147],"鞍山市":[41.107,122.9946],"抚顺市":[41.8808,123.9572],"本溪市":[41.2974,123.7662],"丹东市":[40.1245,124.3854],"锦州市":[41.1001,121.1274],"营口市":[40.6674,122.2351],"阜新市":[42.0151,121.648],"辽阳市":[41.2694,123.1731],"盘锦市":[41.1201,122.0724],"铁岭市":[42.2905,123.8443],"朝阳市":[41.5731,120.451],"葫芦岛市":[40.7551,120.8404],"长春市":[43.817,125.3235],"吉林市":[43.8373,126.5495],"四平市":[43.1664,124.3501],"辽源市":[42.888,125.1311],"通化市":[41.728,125.9372],"白山市":[41.9284,126.4276],"松原市":[45.1415,124.8236],"白城市":[45.6186,122.8401],"延边朝鲜族自治州":[42.904,129.5132],"哈尔滨市":[45.8038,126.535],"齐齐哈尔市":[47.3541,123.9182],"鸡西市":[45.3025,130.9759],"鹤岗市":[47.3072,130.2774],"双鸭山市":[46.6438,131.1573],"大庆市":[46.5862,125.1127],"伊春市":[47.7247,128.899],"佳木斯市":[46.8021,130.3642],"七台河市":[45.7412,131.0035],"牡丹江市":[44.551,129.6105],"黑河市":[50.2452,127.4994],"黑河市":[50.2452,127.4994],"绥化市":[46.6374,126.9688],"大兴安岭地区":[52.3353,124.7115],"上海市":[31.2304,121.4737],"南京市":[32.0602,118.7969],"无锡市":[31.4912,120.3119],"徐州市":[34.2048,117.1848],"常州市":[31.8112,119.9737],"苏州市":[31.299,120.5853],"南通市":[31.9801,120.8942],"连云港市":[34.5967,119.2216],"淮安市":[33.6097,119.0151],"盐城市":[33.3444,120.1636],"扬州市":[32.3942,119.4129],"镇江市":[32.1895,119.4258],"泰州市":[32.4555,119.9231],"宿迁市":[33.9622,118.2751],"杭州市":[30.2741,120.1551],"宁波市":[29.8683,121.544],"温州市":[27.9943,120.6993],"嘉兴市":[30.7451,120.7554],"湖州市":[30.8941,120.0868],"绍兴市":[29.9954,120.5857],"金华市":[29.0784,119.6474],"衢州市":[28.9567,118.8596],"舟山市":[29.9852,122.2072],"台州市":[28.6563,121.4204],"丽水市":[28.4501,119.9213],"合肥市":[31.8205,117.2272],"芜湖市":[31.3524,118.3841],"蚌埠市":[32.915,117.3891],"淮南市":[32.6254,117.0003],"马鞍山市":[31.6705,118.5061],"淮北市":[33.9551,116.7915],"铜陵市":[30.9452,117.8119],"安庆市":[30.5284,117.0583],"黄山市":[29.7145,118.3375],"滁州市":[32.2701,118.317],"阜阳市":[32.8901,115.82],"宿州市":[33.6331,116.9841],"六安市":[31.7541,116.51],"亳州市":[33.8445,115.778],"池州市":[30.655,117.491],"宣城市":[30.9404,118.7571],"福州市":[26.0745,119.2965],"厦门市":[24.4798,118.0894],"莆田市":[25.4541,119.0075],"三明市":[26.2642,117.6433],"泉州市":[24.8741,118.6757],"漳州市":[24.5126,117.6472],"南平市":[26.6412,118.1772],"龙岩市":[25.0754,117.0296],"宁德市":[26.6593,119.5478],"南昌市":[28.682,115.8579],"景德镇市":[29.2693,117.1785],"萍乡市":[27.6212,113.854],"九江市":[29.7042,115.9922],"新余市":[27.8172,114.9168],"鹰潭市":[28.2612,117.0683],"赣州市":[25.8312,114.935],"吉安市":[27.1132,114.986],"宜春市":[27.8105,114.416],"抚州市":[27.9401,116.3571],"上饶市":[28.4412,117.9431],"济南市":[36.651,117.12],"青岛市":[36.0671,120.3826],"淄博市":[36.8134,118.0631],"枣庄市":[34.8101,117.3243],"东营市":[37.4341,118.6722],"烟台市":[37.4631,121.4479],"潍坊市":[36.7067,119.1617],"济宁市":[35.4151,116.587],"泰安市":[36.1951,117.129],"威海市":[37.5132,122.1204],"日照市":[35.4163,119.5273],"临沂市":[35.0601,118.3562],"德州市":[37.4341,116.3571],"聊城市":[36.4574,115.9854],"滨州市":[37.3821,117.9701],"菏泽市":[35.2334,115.4801],"郑州市":[34.7466,113.6253],"开封市":[34.7972,114.3075],"洛阳市":[34.6196,112.454],"平顶山市":[33.7663,113.1924],"安阳市":[36.107,114.3923],"鹤壁市":[35.7483,114.297],"新乡市":[35.3021,113.9268],"焦作市":[35.2151,113.241],"濮阳市":[35.7612,115.0411],"许昌市":[34.0351,113.8524],"漯河市":[33.5812,114.0163],"三门峡市":[34.7724,111.2001],"南阳市":[32.9901,112.5283],"商丘市":[34.414,115.6562],"信阳市":[32.1472,114.0911],"周口市":[33.6251,114.6968],"驻马店市":[32.981,114.0224],"济源市":[35.0901,112.59],"武汉市":[30.5928,114.3055],"黄石市":[30.1983,115.0385],"十堰市":[32.6294,110.799],"宜昌市":[30.6983,111.2858],"襄阳市":[32.0086,112.1224],"鄂州市":[30.3901,114.8906],"荆门市":[31.0354,112.2043],"孝感市":[30.9174,113.9143],"荆州市":[30.3341,112.2393],"黄冈市":[30.4534,114.8724],"咸宁市":[29.8405,114.3213],"随州市":[31.7171,113.382],"恩施土家族苗族自治州":[30.2721,109.4862],"仙桃市":[30.3644,113.4533],"潜江市":[30.4024,112.8967],"天门市":[30.6651,113.1651],"神农架林区":[31.7451,110.6751],"长沙市":[28.2282,112.9388],"株洲市":[27.8274,113.1332],"湘潭市":[27.8291,112.944],"衡阳市":[26.8932,112.6074],"邵阳市":[27.2384,111.4693],"岳阳市":[29.3563,113.1331],"常德市":[29.0315,111.6981],"张家界市":[29.1171,110.4795],"益阳市":[28.5524,112.3551],"郴州市":[25.7701,113.0143],"永州市":[26.4354,111.6119],"怀化市":[27.5501,110.0019],"娄底市":[27.7011,111.9954],"湘西土家族苗族自治州":[28.2974,109.7392],"广州市":[23.1291,113.2644],"韶关市":[24.8105,113.5975],"深圳市":[22.5431,114.0579],"珠海市":[22.2707,113.5767],"汕头市":[23.354,116.6631],"佛山市":[23.0215,113.1227],"江门市":[22.5714,113.0827],"湛江市":[21.2707,110.3591],"茂名市":[21.6621,110.9253],"肇庆市":[23.0515,112.4651],"惠州市":[23.1112,114.4162],"梅州市":[24.2882,116.1219],"汕尾市":[22.7871,115.3751],"河源市":[23.7431,114.6974],"阳江市":[21.8592,111.9822],"清远市":[23.6821,113.0562],"东莞市":[23.0205,113.7518],"中山市":[22.5173,113.3928],"潮州市":[23.6571,116.6223],"揭阳市":[23.5411,116.3725],"云浮市":[22.9151,112.0441],"南宁市":[22.8174,108.3662],"柳州市":[24.3255,109.4158],"桂林市":[25.2345,110.2901],"梧州市":[23.4764,111.279],"北海市":[21.4811,109.1191],"防城港市":[21.6874,108.3544],"钦州市":[21.9671,108.6543],"贵港市":[23.1091,109.6011],"玉林市":[22.6321,110.1511],"百色市":[23.8967,106.6174],"贺州市":[24.4045,111.5674],"河池市":[24.6924,108.062], "来宾市":[23.74,109.23],"崇左市":[22.41,107.35],"海口市":[20.0173,110.349],"三亚市":[18.2524,109.5119],"三沙市":[16.8333,112.3333],"儋州市":[19.52,109.57],"重庆市":[29.5627,106.5523],"成都市":[30.5728,104.0668],"自贡市":[29.3391,104.778],"攀枝花市":[26.581,101.718],"泸州市":[28.871,105.441],"德阳市":[31.127,104.398],"绵阳市":[31.467,104.679],"广元市":[32.435,105.843],"遂宁市":[30.536,105.592],"内江市":[29.58,105.058],"乐山市":[29.562,103.765],"南充市":[30.837,106.11],"眉山市":[30.075,103.848],"宜宾市":[28.751,104.643],"广安市":[30.456,106.633],"达州市":[31.209,107.468],"雅安市":[29.98,103.012],"巴中市":[31.859,106.753],"资阳市":[30.122,104.627],"阿坝藏族羌族自治州":[31.899,102.221],"甘孜藏族自治州":[30.049,101.962],"凉山彝族自治州":[27.881,102.261],"贵阳市":[26.647,106.63],"六盘水市":[26.59,104.83],"遵义市":[27.72,106.92],"安顺市":[26.25,105.94],"毕节市":[27.3,105.28],"铜仁市":[27.72,109.18],"黔西南布依族苗族自治州":[25.08,104.9],"黔东南苗族侗族自治州":[26.58,107.98],"黔南布依族苗族自治州":[26.25,107.51],"昆明市":[25.04,102.71],"曲靖市":[25.49,103.79],"玉溪市":[24.35,102.54],"保山市":[25.11,99.16],"昭通市":[27.33,103.71],"丽江市":[26.86,100.22],"普洱市":[22.78,100.97],"临沧市":[23.88,100.08],"楚雄彝族自治州":[25.04,101.54],"红河哈尼族彝族自治州":[23.36,103.38],"文山壮族苗族自治州":[23.36,104.24],"西双版纳傣族自治州":[22.01,100.79],"大理白族自治州":[25.59,100.22],"德宏傣族景颇族自治州":[24.43,98.58],"怒江傈僳族自治州":[25.85,98.85],"迪庆藏族自治州":[27.82,99.7],"拉萨市":[29.65,91.11],"日喀则市":[29.26,88.88],"昌都市":[31.14,97.17],"山南市":[29.23,91.76],"那曲市":[31.47,92.05],"阿里地区":[32.5,80.1],"林芝市":[29.65,94.36],"西安市":[34.26,108.94],"铜川市":[34.89,108.94],"宝鸡市":[34.36,107.14],"咸阳市":[34.33,108.7],"渭南市":[34.5,109.5],"延安市":[36.58,109.48],"汉中市":[33.07,107.02],"榆林市":[38.29,109.74],"安康市":[32.68,109.02],"商洛市":[33.86,109.93],"兰州市":[36.06,103.82],"嘉峪关市":[39.77,98.27],"金昌市":[38.51,102.18],"白银市":[36.54,104.17],"天水市":[34.58,105.72],"武威市":[37.93,102.63],"张掖市":[38.93,100.45],"平凉市":[35.54,106.66],"酒泉市":[39.74,98.5],"庆阳市":[35.73,107.63],"定西市":[34.85,104.62],"陇南市":[33.4,104.92],"临夏回族自治州":[35.6,103.21],"甘南藏族自治州":[34.98,102.91],"西宁市":[36.62,101.77],"海东市":[36.5,102.1],"海北藏族自治州":[36.95,100.9],"黄南藏族自治州":[35.52,102.01],"海南藏族自治州":[36.28,100.62],"果洛藏族自治州":[34.47,100.24],"玉树藏族自治州":[33.01,97.0],"海西蒙古族藏族自治州":[37.37,97.37],"银川市":[38.46,106.27],"石嘴山市":[39.01,106.39],"吴忠市":[37.98,106.21],"固原市":[36.0,106.28],"中卫市":[37.51,105.18],"乌鲁木齐市":[43.82,87.61],"克拉玛依市":[45.59,84.87],"吐鲁番市":[42.94,89.18],"哈密市":[42.82,93.51],"昌吉回族自治州":[44.02,87.3],"博尔塔拉蒙古自治州":[44.9,82.07],"巴音郭楞蒙古自治州":[41.76,86.15],"阿克苏地区":[41.16,80.26],"克孜勒苏柯尔克孜自治州":[39.71,76.17],"喀什地区":[39.46,75.98],"和田地区":[37.11,79.91],"伊犁哈萨克自治州":[43.91,81.31],"塔城地区":[46.74,82.98],"阿勒泰地区":[47.84,88.13],"石河子市":[44.3,86.03],"阿拉尔市":[40.54,81.28],"图木舒克市":[39.86,79.07],"五家渠市":[44.16,87.56],"北屯市":[47.35,87.82],"铁门关市":[41.82,86.19],"双河市":[44.84,82.35],"可克达拉市":[43.82,80.64],"昆玉市":[37.2,79.28],"胡杨河市":[44.84,84.85],"新星市":[42.82,93.51]}

def latlon_to_city(lat: float, lon: float) -> Optional[str]:
    """
    将经纬度转换为最接近的地级行政区。
    采用简单的球面距离（欧几里得近似）计算。
    """
    cache_key = f"{round(lat, 2)}_{round(lon, 2)}"
    if cache_key in _city_cache:
        return _city_cache[cache_key]

    min_dist = float('inf')
    found_city = None

    for city, coord in CHINA_CITIES.items():
        # coord 为 (lat, lon)
        d_lat = lat - coord[0]
        d_lon = lon - coord[1]
        
        # 针对中国经纬度范围，经度 1 度的距离随纬度变化，这里做个简单加权
        # 30 度纬度附近，cos(30) 约为 0.86
        dist_sq = d_lat**2 + (d_lon * 0.86)**2
        
        if dist_sq < min_dist:
            min_dist = dist_sq
            found_city = city

    if found_city:
        # 去除“市”、“地区”、“盟”等后缀，让文件夹名更简洁
        clean_name = found_city
        for suffix in ["市", "地区", "蒙古族藏族自治州", "藏族自治州", "哈萨克自治州", "回族自治州", "藏族羌族自治州", "土家族苗族自治州", "苗族侗族自治州", "布依族苗族自治州", "哈尼族彝族自治州", "壮族苗族自治州", "傣族景颇族自治州", "傈僳族自治州", "傣族自治州", "彝族自治州", "盟"]:
            if clean_name.endswith(suffix):
                clean_name = clean_name[:-len(suffix)]
                break
        
        _city_cache[cache_key] = clean_name
        return clean_name

    return f"位置_{round(lat, 2)}_{round(lon, 2)}"
